# 間違い探し自動生成システム - ユーザーガイド

## 目次
1. [概要](#概要)
2. [主な機能](#主な機能)
3. [使い方](#使い方)
4. [新機能の詳細](#新機能の詳細)
5. [技術仕様](#技術仕様)
6. [トラブルシューティング](#トラブルシューティング)

---

## 概要

**NewSpotTheDiff**は、AIを活用して1枚の画像から自動的に「間違い探し」パズルを生成するWebアプリケーションです。FastSAM（高速セグメンテーションモデル）を使用してオブジェクトを検出し、自然な画像変更を適用することで、高品質な間違い探しを作成します。

### 主な特徴
- 🤖 **AI自動生成**: 1枚の画像から自動的に間違い探しを作成
- 🎯 **3段階の難易度**: 簡単（3-4箇所）、普通（5-6箇所）、難しい（7-8箇所）
- 📄 **A4レイアウト**: 印刷に適したA4横サイズの出力
- 🔴 **答え表示機能**: 赤い丸で答えを明示
- ⚡ **リアルタイム処理**: 処理状況をリアルタイムで表示
- 🎨 **高品質な画像処理**: 最新技術を応用した自然な変更

---

## 主な機能

### 1. 画像アップロード
- **対応形式**: PNG, JPG, JPEG
- **画像サイズ**: 512px × 512px ～ 4096px × 4096px
- **ファイルサイズ**: 最大10MB
- **アップロード方法**: ドラッグ&ドロップまたはファイル選択

### 2. 難易度選択
| 難易度 | 違いの数 | オブジェクトの目立ちやすさ |
|--------|----------|---------------------------|
| 簡単   | 3-4箇所  | 目立つオブジェクトを変更 |
| 普通   | 5-6箇所  | 中程度の目立ち方 |
| 難しい | 7-8箇所  | 目立たないオブジェクトも含む |

### 3. 変更タイプ
システムは以下の3種類の変更を自動的に適用します：

#### 🗑️ 削除（Deletion）
- オブジェクトを画像から削除
- 高度なインペインティング技術で自然に背景を補完
- 小〜中サイズのオブジェクトに適用

#### 🎨 色変更（Color Change）
- オブジェクトの色を変更
- 元の色と明確に異なる色を自動選択
- エッジをぼかして自然な仕上がりに

#### ➕ 追加（Addition）
- オブジェクトを複製して別の場所に配置
- 背景に合わせて明るさを調整
- 自然な配置場所を自動選択

### 4. 出力形式

#### 基本画像セット
- `original.png` - オリジナル画像
- `modified.png` - 間違い探し画像（変更後）
- `metadata.json` - 変更情報のメタデータ

#### 答え付き画像セット
- `original_with_answers.png` - 答えを赤丸で表示した元画像
- `modified_with_answers.png` - 答えを赤丸で表示した間違い探し画像

#### A4レイアウト（300 DPI）
- `a4_layout.png` - A4横サイズで両画像を並べたレイアウト
- `a4_layout_with_answers.png` - 答え付きA4レイアウト
- サイズ: 3508px × 2480px（印刷品質）

---

## 使い方

### ステップ1: 画像のアップロード
1. トップページにアクセス
2. 画像をドラッグ&ドロップ、または「ファイルを選択」をクリック
3. プレビューで画像を確認

### ステップ2: 難易度の選択
1. 「簡単」「普通」「難しい」から選択
2. 選択肢の下に違いの数が表示されます

### ステップ3: 生成開始
1. 「間違い探しを生成」ボタンをクリック
2. 処理ページに自動的に移動

### ステップ4: 処理の確認
処理中、以下の5つのステップがリアルタイムで表示されます：
1. 📁 **画像読み込み** - アップロードされた画像を読み込み
2. 🔍 **オブジェクト検出** - FastSAMでオブジェクトを検出
3. 🎯 **顕著性解析** - 各オブジェクトの目立ち方を分析
4. ✨ **画像変更** - 選択されたオブジェクトに変更を適用
5. ✅ **最終処理** - 答え画像とA4レイアウトを生成

処理時間の目安: 12〜18秒（CPUのみの場合）

### ステップ5: 結果の確認とダウンロード
1. 処理完了後、結果ページに自動的に移動
2. 元画像と間違い探し画像が並んで表示されます

#### 利用可能な機能
- **オリジナルをDL** - 元画像をダウンロード
- **間違い探しをDL** - 間違い探し画像をダウンロード
- **A4レイアウトをDL** - 印刷用A4レイアウトをダウンロード
- **答え画像をDL** - 答えを赤丸で表示した画像をダウンロード
- **答えを見る** - 答えのリストと赤丸付き画像を表示
- **A4表示に切替** - A4レイアウトのプレビューを表示

---

## 新機能の詳細

### 🔴 答えの視覚化（赤い丸）

答え表示機能では、各違いの箇所に赤い丸が描画されます：

**特徴:**
- **赤い円**: 各違いの中心に描画
- **適応的サイズ**: オブジェクトのサイズに応じて円のサイズを調整
- **中心点マーカー**: 各円の中心に小さな点を表示
- **パディング**: オブジェクトの周辺も含めて表示

**使用方法:**
1. 結果ページで「答えを見る」ボタンをクリック
2. 答えのリストが表示され、元画像と間違い探し画像に赤丸が表示されます
3. 「答え画像をDL」で答え付き画像をダウンロード可能

---

### 📄 A4レイアウト機能

印刷に適したA4横サイズ（297mm × 210mm）で、元画像と間違い探し画像を横に並べた形式で出力します。

**仕様:**
- **サイズ**: 3508px × 2480px（300 DPI）
- **レイアウト**:
  - 上部: タイトル「間違い探しパズル」
  - 中央: 元画像（左）と間違い探し（右）を並べて配置
  - 各画像にラベル表示
- **背景**: 白色
- **マージン**: 適切な余白を配置

**使用方法:**
1. 結果ページで「A4表示に切替」をクリック
2. A4レイアウトのプレビューが表示されます
3. 「A4レイアウトをDL」で通常版をダウンロード
4. 「A4答え付きをDL」で答え付き版をダウンロード

**印刷時の推奨設定:**
- 用紙サイズ: A4横
- 印刷品質: 高品質（300 DPI）
- 色: カラー
- 余白: なし（画像に既に余白を含む）

---

### 🎨 精度向上機能

最新の画像処理技術を適用して、より自然で高品質な間違い探しを生成します。

#### 1. 高度なインペインティング（削除）
**改善内容:**
- **自動品質評価**: Navier-StokesとTeleaの両方の方法を試して、より良い結果を自動選択
- **適応的半径**: マスクのサイズに応じてインペインティング半径を調整
- **エッジスムージング**: バイラテラルフィルタでアーティファクトを軽減
- **品質メトリクス**: エッジの滑らかさを評価して最適な結果を選択

**結果:**
- より自然な背景の補完
- 削除の痕跡が目立たない
- エッジのアーティファクトを最小化

#### 2. インテリジェントな色変更
**改善内容:**
- **補色・三次色の選択**: 元の色と明確に異なる色を自動選択
- **色相差の確保**: 最低40度以上の色相差を保証
- **彩度とバリューの調整**: 色をより鮮やかに、視認性を向上
- **距離変換ブレンディング**: エッジの自然な遷移を実現

**結果:**
- より見分けやすい色の変更
- 自然なエッジブレンディング
- 過度に派手にならない適度な変更

#### 3. 自然なオブジェクト追加
**改善内容:**
- **背景色マッチング**: 配置場所の背景色を考慮した位置選択
- **明るさ適応**: 周囲の明るさに合わせてオブジェクトの明るさを調整
- **高度なアルファブレンディング**: 距離変換を使用した自然な合成
- **エッジポストプロセッシング**: バイラテラルフィルタでエッジを滑らかに

**結果:**
- より自然な配置
- 周囲の環境に調和
- 追加の痕跡が目立たない

---

### ⚡ 処理プロセスの視覚化

リアルタイムで処理状況を確認できる、視覚的に分かりやすいプログレス表示を実装しています。

**表示要素:**

1. **プログレスバー**
   - 全体の進捗を0-100%で表示
   - 滑らかなアニメーション
   - グラデーションカラー

2. **処理ステップの視覚化**
   - 5つのステップをアイコンで表示
   - 各ステップの状態（待機中/処理中/完了）を色分け
   - 処理中のステップはパルスアニメーション
   - 完了したステップはバウンスアニメーション

3. **推定残り時間**
   - リアルタイムで残り時間を計算
   - 適応的な推定（実際の処理速度に基づく）

4. **詳細ステータスメッセージ**
   - 現在行っている処理の説明
   - 日本語での分かりやすい表示

**ステップの内訳:**
1. 📁 画像読み込み（5-10%）
2. 🔍 オブジェクト検出（10-50%）- 最も時間がかかる
3. 🎯 顕著性解析（50-55%）- 高速
4. ✨ 画像変更（55-92%）
5. ✅ 最終処理（92-100%）- 答え画像とA4レイアウト生成

---

## 技術仕様

### アーキテクチャ

```
┌─────────────────────────────────────────────┐
│           Webブラウザ (UI)                   │
│  - アップロード                              │
│  - プログレス表示                            │
│  - 結果表示                                  │
└──────────────┬──────────────────────────────┘
               │ HTTP/JSON
┌──────────────┴──────────────────────────────┐
│         Flask APIサーバー                     │
│  - ルーティング                              │
│  - ジョブ管理                                │
│  - 非同期処理                                │
└──────────────┬──────────────────────────────┘
               │
┌──────────────┴──────────────────────────────┐
│      画像処理サービス                        │
├──────────────────────────────────────────────┤
│  - SegmentationService (FastSAM)           │
│  - SaliencyService (顕著性解析)             │
│  - InpaintingService (削除)                │
│  - ColorChanger (色変更)                    │
│  - ObjectDuplicator (追加)                 │
│  - AnswerVisualizer (答え表示)              │
│  - A4LayoutComposer (レイアウト)            │
└──────────────────────────────────────────────┘
```

### 技術スタック

#### バックエンド
- **Python 3.10+**
- **Flask 3.x** - Webフレームワーク
- **Ultralytics FastSAM** - オブジェクトセグメンテーション
- **OpenCV 4.8+** - 画像処理
- **Pillow 10.0+** - 画像I/O
- **NumPy** - 数値計算
- **SQLite** - データベース

#### フロントエンド
- **HTML5 / CSS3**
- **Vanilla JavaScript**
- **Fetch API** - 非同期通信

#### AI/ML
- **FastSAM-x** - Segment Anything Modelの高速版
- **OpenCV Spectral Residual** - 顕著性マップ生成
- **OpenCV Inpainting** - Navier-Stokes / Teleaアルゴリズム

### パフォーマンス

**処理時間（CPU環境）:**
- セグメンテーション: 8-12秒（最大のボトルネック）
- 顕著性解析: 0.1秒
- 各変更処理: 0.3-0.8秒/個
- 答え画像生成: 0.5秒
- A4レイアウト生成: 1-2秒
- **合計: 12-20秒**

**GPU使用時の改善見込み:**
- セグメンテーション: 1-2秒（約6-10倍高速化）
- 合計: 3-8秒

---

## トラブルシューティング

### よくある問題と解決方法

#### Q1: アップロードできない
**原因:**
- ファイルサイズが10MBを超えている
- 対応していないファイル形式
- 画像サイズが範囲外（512px未満または4096px超過）

**解決方法:**
1. 画像サイズを確認してください
2. PNG、JPG、JPEG形式を使用してください
3. 画像を圧縮またはリサイズしてください

#### Q2: 処理が失敗する
**原因:**
- 検出されたオブジェクトが少なすぎる
- 画像が単純すぎる（単色背景など）

**解決方法:**
1. より複雑な画像を使用してください
2. 複数のオブジェクトが含まれる画像を選んでください
3. 背景が単純すぎる画像は避けてください

#### Q3: 違いが不自然に見える
**原因:**
- オブジェクトが大きすぎる
- 背景が複雑すぎる

**解決方法:**
1. 難易度を「簡単」に設定して試してください
2. 異なる画像で再試行してください
3. 中〜小サイズのオブジェクトが多い画像を使用してください

#### Q4: 処理が遅い
**原因:**
- FastSAMのセグメンテーションに時間がかかる
- CPUのみで処理している

**現状:**
- 通常12-20秒程度の処理時間です
- これは FastSAM の AI 処理の性質上、避けられません

**将来の改善:**
- GPU対応により大幅な高速化が可能です

---

## 推奨される使用画像

### 良好な結果が得られる画像の特徴
✅ 複数の明確なオブジェクトがある
✅ 適度な背景の複雑さ
✅ 十分なサイズ（1000px以上推奨）
✅ 明瞭な境界線
✅ 適度なコントラスト

### 避けるべき画像の特徴
❌ 単色またはグラデーション背景のみ
❌ オブジェクトが1-2個のみ
❌ 極端にぼかしが強い画像
❌ 非常に小さい画像（512px未満）
❌ テキストが主体の画像

### 推奨される画像の例
- 🏞️ 風景写真（自然、都市）
- 🏠 室内写真（家具、小物が多い）
- 🎨 イラスト（キャラクター、オブジェクトが明確）
- 📸 静物写真
- 🎪 イベント写真

---

## システム要件

### サーバー側
- **OS**: Windows / Linux / macOS
- **Python**: 3.10以上
- **RAM**: 最低4GB、推奨8GB以上
- **ストレージ**: 2GB以上の空き容量
- **CPU**: マルチコア推奨

### クライアント側
- **ブラウザ**:
  - Chrome 90以上
  - Firefox 88以上
  - Safari 14以上
  - Edge 90以上
- **JavaScript**: 有効にする必要があります
- **インターネット接続**: 必須

---

## サポートとフィードバック

### 問題報告
問題が発生した場合は、以下の情報を含めて報告してください：
1. 使用したブラウザとバージョン
2. エラーメッセージ（あれば）
3. 使用した画像の特徴（サイズ、形式など）
4. 選択した難易度
5. 問題が発生したステップ

### フィードバック
- GitHub Issues: [プロジェクトのGitHubページ]
- 機能要望や改善提案も歓迎します

---

## ライセンスと利用規約

このシステムは教育・個人利用目的で開発されています。
商用利用については別途ライセンスが必要な場合があります。

使用している主要なライブラリ：
- FastSAM: [ライセンス](https://github.com/CASIA-IVA-Lab/FastSAM)
- OpenCV: Apache License 2.0
- Flask: BSD License

---

## バージョン履歴

### Version 2.0（現在のバージョン）
**新機能:**
- ✨ 答えの視覚化（赤い丸）機能
- 📄 A4レイアウト出力機能
- 🎨 精度向上（インペインティング、色変更、オブジェクト追加）
- ⚡ 処理プロセスの視覚化
- 🔧 UIの改善

**改善:**
- より自然な画像変更
- 適応的な時間推定
- レスポンシブなプログレス表示

### Version 1.0（初期バージョン）
- 基本的な間違い探し生成機能
- 3段階の難易度設定
- FastSAMによるセグメンテーション
- 3種類の変更タイプ（削除、色変更、追加）

---

## よくある質問（FAQ）

### Q: GPUは必要ですか？
A: いいえ、CPUのみで動作しますが、GPUがあれば処理が大幅に高速化されます。

### Q: 一度に複数の画像を処理できますか？
A: 現在はバッチ処理には対応していません。1枚ずつ処理してください。

### Q: 生成された画像の著作権は？
A: 元画像の著作権に従います。商用利用の場合は元画像の権利を確認してください。

### Q: 人物写真でも使えますか？
A: 技術的には可能ですが、プライバシーと肖像権に注意してください。

### Q: オフラインで使えますか？
A: サーバー側のセットアップが必要ですが、セットアップ後はローカルネットワークで使用可能です。

---

このガイドが「間違い探し自動生成システム」の使用に役立つことを願っています！
楽しい間違い探し作成をお楽しみください！ 🎨✨
