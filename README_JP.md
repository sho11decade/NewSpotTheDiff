# NewSpotTheDiff - 次世代AI間違い探し自動生成

**NewSpotTheDiff**は、アップロードされた1枚の画像から自動的に間違い探しパズルを生成するAI搭載Webアプリケーションです。最先端のコンピュータビジョン技術により、オブジェクトを検出し、複数の戦略的な変更を加えることで、様々な難易度レベルの魅力的なパズルを生成します。

## ✨ バージョン2.1.1 - セキュリティ＆ページ更新

**新機能:** 本番環境に対応した強化されたセキュリティ対策と情報ページ！

- 🔒 **セキュリティヘッダー**: Flask-TalismanによるCSP、HSTS、X-Frame-Optionsなど
- 🚦 **レート制限**: DoS攻撃対策に対応した設定可能な制限（10アップロード/分、5生成/分）
- 📋 **プライバシーポリシー**: データ取り扱いとプライバシー情報の詳細
- ℹ️ **アプリについて**: アプリケーション機能、技術スタック、バージョン履歴
- ⚖️ **利用規約**: 利用条件、制限事項、法的枠組み

[セキュリティ改善の詳細 →](docs/SECURITY_IMPROVEMENTS_JP.md)

## ✨ バージョン2.1 - 品質改善

**より自然で洗練された結果を実現する品質評価システムの強化！**

- 🎯 **品質評価機能**: 低品質なセグメントと変更の自動フィルタリング
- 📊 **31%の品質向上**: エッジの滑らかさ、自然な色合い、配置の改善
- 🔍 **スマートリトライ機構**: 失敗した変更を異なるアプローチで自動的に再試行
- ⚡ **パフォーマンスへの影響が最小限**: 追加処理時間はわずか0〜2秒

[品質改善の詳細 →](docs/QUALITY_IMPROVEMENT_JP.md)

## 機能

### コア機能
- **AI搭載オブジェクト検出**: FastSAM（Segment Anythingモデル）による自動オブジェクトセグメンテーション
- **インテリジェントな差異生成**: オブジェクトの削除、色の変更、複製により自然な違いを作成
- **マルチレベル難易度**: 簡単、普通、難しいレベルでパズルを生成
- **進捗追跡**: リアルタイムのジョブステータス更新と進捗通知
- **並列比較**: オリジナルと変更後の画像を比較できるインタラクティブUI

### 高度な機能（v2.0以降）
- 🔴 **答えの可視化**: すべての違いを赤い円で自動的にハイライト
- 📄 **A4レイアウトエクスポート**: 印刷可能なA4横向きフォーマット（3508×2480px @ 300 DPI）
- 🎨 **画像処理の強化**: インペインティング、色の変更、オブジェクトの追加の自動品質評価
- ⚡ **プロセスの可視化**: リアルタイム更新付きのアニメーション5ステップ進捗表示
- 🌐 **完全日本語UI/UX**: 完全にローカライズされたインターフェースとドキュメント

### セキュリティ＆コンプライアンス（v2.1.1以降）
- 🔒 **セキュリティヘッダー**: Content Security Policy、HSTS、XSS保護
- 🚦 **レート制限**: 悪用防止のためのAPIスロットリング（Flask-Limiter）
- 📋 **法的ページ**: プライバシーポリシー、利用規約、アプリについて
- 🛡️ **入力検証**: マジックバイト検証付きのファイル種類、サイズ、寸法チェック

### 技術的ハイライト
- **品質優先の処理**: 組み込み品質評価システム（v2.1以降）
- **CPUのみの処理**: GPUアクセラレーションなしでノートPCやラップトップで動作
- **レスポンシブWebインターフェース**: リアルタイムフィードバック付きのドラッグ＆ドロップ画像アップロード
- **非同期ジョブ処理**: ThreadPoolExecutorを使用したバックグラウンドタスク処理
- **堅牢な画像検証**: マジックバイトチェック付きのファイル種別、サイズ、寸法検証
- **クリーンアーキテクチャ**: ルート、サービス、モデル、ユーティリティの明確な責任分離

## クイックスタート

### 前提条件
- Python 3.10以降
- `uv`パッケージマネージャー（またはpip）

### インストール

1. **リポジトリのクローン**
   ```bash
   git clone <repository-url>
   cd NewSpotTheDiff
   ```

2. **UVを使用して依存関係をインストール**
   ```bash
   uv sync
   ```

   またはpipを使用:
   ```bash
   pip install -r requirements.txt
   ```

3. **FastSAMモデルのダウンロード**（自動または手動）

   オプションA - 自動（初回実行時）:
   ```bash
   python scripts/download_model.py
   ```

   オプションB - 手動:
   - [Ultralytics Hub](https://hub.ultralytics.com)から`FastSAM-x.pt`をダウンロード
   - `instance/models/`ディレクトリに配置

4. **データベースの初期化**
   ```bash
   python scripts/init_db.py
   ```

5. **アプリケーションの実行**
   ```bash
   python run.py
   ```

   アプリケーションは`http://localhost:5000`でアクセスできます

## 使い方

### 基本的なワークフロー

1. **画像のアップロード**: ホームページに移動し、画像をドラッグ＆ドロップまたは選択
   - サポートフォーマット: PNG、JPEG
   - 画像サイズ: 512px〜4096px
   - ファイルサイズ制限: 10MB

2. **難易度の選択**: パズルの難易度レベルを選択
   - **簡単**: 3箇所の違い（大きく、明らかな変更）
   - **普通**: 5箇所の違い（混合オブジェクトサイズ）
   - **難しい**: 7箇所の違い（小さく、微妙な変更）

3. **パズルの生成**: 処理のために送信
   - 処理時間: 8〜15秒（主にオブジェクト検出のため）

4. **結果の表示**: オリジナルと変更後の画像を比較
   - 「違いを表示」をトグルして答えを表示
   - オリジナルとパズル画像の両方をダウンロード

## プロジェクト構造

```
NewSpotTheDiff/
├── run.py                          # アプリケーションエントリーポイント
├── pyproject.toml                  # プロジェクト設定と依存関係
├── requirements.txt                # 本番環境用依存関係
├── README.md                       # 英語版README
├── README_JP.md                    # このファイル（日本語版README）
├── DEPLOYMENT.md                   # デプロイメントガイド
│
├── src/
│   ├── app.py                      # Flaskアプリケーションファクトリー
│   ├── config.py                   # 設定
│   ├── database.py                 # データベース初期化と管理
│   ├── exceptions.py               # カスタム例外
│   │
│   ├── routes/                     # HTTPリクエストハンドラ
│   ├── services/                   # ビジネスロジックとAI処理
│   ├── models/                     # データモデル
│   ├── utils/                      # ユーティリティ関数
│   ├── static/                     # 静的ファイル（CSS、JS、画像）
│   └── templates/                  # HTMLテンプレート
│
├── scripts/                        # ユーティリティスクリプト
├── instance/                       # ランタイムデータ（gitに含まれない）
├── tests/                          # テストスイート
└── docs/                           # ドキュメント
```

## 技術スタック

| コンポーネント | 技術 | 目的 |
|-----------|-----------|---------|
| Webフレームワーク | Flask 3.x | HTTPリクエスト処理とルーティング |
| オブジェクト検出 | FastSAM (Ultralytics) | AI搭載オブジェクトセグメンテーション |
| 画像処理 | OpenCV | インペインティング、顕著性分析、色操作 |
| 画像ライブラリ | Pillow | 画像フォーマット互換性 |
| 数値計算 | NumPy | 配列演算と処理 |
| データベース | SQLite | ジョブと結果の永続化 |
| 本番サーバー | Gunicorn | WSGIサーバー |

## 設定

`src/config.py`の主な設定:

```python
MAX_CONTENT_LENGTH = 10 * 1024 * 1024  # 10MBアップロード制限
MIN_IMAGE_DIMENSION = 512               # 最小寸法
MAX_IMAGE_DIMENSION = 4096              # 最大寸法
PROCESSING_IMAGE_SIZE = 1024            # 標準処理サイズ
MAX_WORKERS = 2                         # バックグラウンド処理スレッド

# 難易度プリセット
DIFFICULTY_CONFIG = {
    'easy': {'num_changes': 3, 'max_saliency': 0.65},
    'medium': {'num_changes': 5, 'max_saliency': 0.45},
    'hard': {'num_changes': 7, 'max_saliency': 0.25}
}
```

## デプロイメント

### Leapcellへのデプロイ

詳細な手順については[DEPLOYMENT.md](DEPLOYMENT.md)を参照してください。

**クイックスタート:**
1. GitHubにプッシュ
2. Leapcellに接続
3. 環境変数を設定
4. デプロイ

**必要な環境変数:**
- `SECRET_KEY`: Flaskセッション用のシークレットキー
- `SITE_DOMAIN`: あなたのドメイン（例: spotthediff.ricezero.fun）
- `GOOGLE_ANALYTICS_ID`: Google Analytics ID（オプション）

## 開発

### テストの実行
```bash
pytest
```

### コード品質
プロジェクトは100文字の行長制限でRuffを使用しています。

```bash
ruff check .
```

## パフォーマンス特性

- **オブジェクト検出（FastSAM）**: 画像あたり8〜12秒（CPU）
- **顕著性分析**: 約0.1秒
- **インペインティング（オブジェクトごと）**: 0.3〜0.8秒
- **色の変更**: オブジェクトあたり約50〜100ms
- **合計処理時間**: 画像の複雑さと難易度に応じて8〜15秒

これらの時間は、GPUアクセラレーションなしの一般的なノートPCハードウェアに基づいています。

## 制限事項と今後の改善

### 現在の制限事項
- オブジェクト検出速度はCPUパフォーマンスに依存
- 大きなオブジェクトは削除の代わりに色変更を使用する場合がある
- 単一画像入力（バッチ処理なし）
- 違いは非永続的（リクエストごとに再生成）

### 今後の予定機能
- バッチパズル生成
- 永続的な違い生成（再訪問時に同じパズル）
- ユーザーアカウントとパズルコレクション
- マルチプレイヤー対戦モード
- GPUアクセラレーションサポート
- カスタムパズルテンプレートと難易度の微調整

## トラブルシューティング

### FastSAMモデルが見つからない
```
FileNotFoundError: FastSAM model not found
```
解決策: `python scripts/download_model.py`を実行

### 画像アップロード失敗
- 画像フォーマットがPNGまたはJPEGであることを確認
- ファイルサイズが10MB以下であることを確認
- 画像寸法が512px〜4096pxの間であることを確認

### 生成タイムアウト
- 処理は通常8〜15秒かかります
- 処理中にブラウザを閉じないでください
- エラーについてはブラウザコンソールを確認

## 貢献

貢献を歓迎します！次の点にご注意ください:
1. 既存のコードスタイルとアーキテクチャに従う
2. 新機能にはテストを追加
3. 必要に応じてドキュメントを更新
4. 変更を送信する前に十分にテスト

## ライセンス

[ライセンス情報は追加予定]

## お問い合わせとサポート

質問、問題、提案については、プロジェクトリポジトリにアクセスするか、開発チームにお問い合わせください。

---

製作: RiceZero | Powered by FastSAM and OpenCV
