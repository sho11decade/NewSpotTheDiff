# 次世代型間違い探し自動生成システム - 要件定義書

## 1. プロジェクト概要

### 1.1 目的
画像から自動的に間違い探し問題を生成し、ユーザーがオリジナルの間違い探しコンテンツを楽しむことができるWebアプリケーションを構築する。

### 1.2 背景
従来の間違い探しコンテンツは手動で作成する必要があり、制作コストが高い。AI技術を活用することで、自動生成を実現し、誰でも気軽に間違い探しを作成・楽しむことができる環境を提供する。

### 1.3 システムの特徴
- 最新のAI技術（SAM 2、LaMa、DeepGaze）を活用した自動生成
- 顕著性解析により適切な難易度調整が可能
- Webインターフェースにより簡単に利用可能

---

## 2. 機能要件

### 2.1 必須機能（MVP）

#### 2.1.1 画像アップロード機能
- **FR-001**: ユーザーは画像（JPEG、PNG形式）をアップロードできる
- **FR-002**: アップロード可能なファイルサイズの上限は10MB
- **FR-003**: 画像解像度は最大4096x4096ピクセルまでサポート
- **FR-004**: 不適切な画像形式の場合、エラーメッセージを表示

#### 2.1.2 物体検出・セグメンテーション機能
- **FR-005**: SAM 2を使用して画像内の物体を自動検出
- **FR-006**: 検出された物体のセグメンテーションマスクを生成
- **FR-007**: 最低10個以上の物体を検出可能（画像内容による）
- **FR-008**: セグメンテーション結果の可視化表示

#### 2.1.3 顕著性解析機能
- **FR-009**: DeepGaze IIまたはOpenCV Saliency APIを使用して顕著性マップを生成
- **FR-010**: 各物体の顕著性スコアを算出
- **FR-011**: 顕著性スコアに基づいて物体を優先順位付け

#### 2.1.4 間違い生成機能
- **FR-012**: 以下の3種類の間違いを生成可能：
  - 物体の削除（Inpainting）
  - 物体の色変更
  - 物体の追加（既存物体の複製）
- **FR-013**: 難易度設定（簡単・普通・難しい）が可能
  - 簡単：高顕著性の物体を3-4個変更
  - 普通：中顕著性の物体を5-6個変更
  - 難しい：低顕著性の物体を7-10個変更
- **FR-014**: LaMaを使用した高品質な画像補完処理

#### 2.1.5 結果表示・ダウンロード機能
- **FR-015**: オリジナル画像と間違い探し画像を並べて表示
- **FR-016**: 変更箇所のハイライト表示機能
- **FR-017**: 生成した画像をダウンロード可能（PNG形式）
- **FR-018**: 間違いの座標情報をJSON形式でダウンロード可能

### 2.2 将来的な拡張機能

#### 2.2.1 高度な編集機能
- **FR-019**: ユーザーが手動で間違い箇所を指定・編集
- **FR-020**: 物体の移動・回転機能
- **FR-021**: カスタム物体の追加機能

#### 2.2.2 ゲーム機能
- **FR-022**: ブラウザ上で間違い探しをプレイ可能
- **FR-023**: タイマー機能と正解判定
- **FR-024**: スコアリングシステム

#### 2.2.3 データ管理機能
- **FR-025**: 過去に生成した問題の保存・管理
- **FR-026**: ユーザーアカウント機能
- **FR-027**: 問題の共有機能

---

## 3. 非機能要件

### 3.1 性能要件
- **NFR-001**: 画像アップロードから結果表示までの処理時間は120秒以内（GPU使用時）
  - 物体検出：20-30秒
  - 顕著性解析：10-15秒
  - 画像補完：40-60秒（複数物体処理）
  - その他処理：10-15秒
- **NFR-002**: 同時接続ユーザー数は最大10名まで対応（初期段階）
- **NFR-003**: システムの可用性は開発段階で95%以上

### 3.2 スケーラビリティ
- **NFR-004**: 将来的にGPUサーバーをスケールアウト可能な設計
- **NFR-005**: バックグラウンドジョブキューの導入を想定した設計

### 3.3 セキュリティ
- **NFR-006**: アップロードファイルのウイルススキャン
- **NFR-007**: ファイルアップロードサイズの制限
- **NFR-008**: XSS、CSRF対策の実装
- **NFR-009**: 個人情報を含む画像のアップロード時の注意喚起

### 3.4 互換性
- **NFR-010**: 以下のブラウザで動作保証：
  - Chrome（最新版）
  - Firefox（最新版）
  - Safari（最新版）
  - Edge（最新版）
- **NFR-011**: レスポンシブデザイン（デスクトップ優先、タブレット対応）

### 3.5 保守性・運用性
- **NFR-012**: ログ記録機能（アクセスログ、エラーログ）
- **NFR-013**: エラーハンドリングと適切なエラーメッセージ表示
- **NFR-014**: コードの可読性とドキュメント整備
- **NFR-015**: AIモデルのバージョン管理

---

## 4. システム制約

### 4.1 技術的制約
- **C-001**: CUDA対応GPUが必須（NVIDIA製、CUDA 12.1以上）
- **C-002**: GPUメモリは最低8GB以上推奨（SAM 2 Tinyモデル使用時）
- **C-003**: システムメモリは16GB以上推奨
- **C-004**: Linux環境を推奨（Windows環境ではWSL2が必要）
- **C-005**: Python 3.10以上が必須

### 4.2 ライセンス制約
- **C-006**: SAM 2のライセンス：Apache 2.0（商用利用可能）
- **C-007**: LaMaのライセンス：Apache 2.0（商用利用可能）
- **C-008**: DeepGaze IIのライセンス：要確認（明示なし）→代替としてOpenCV Saliency APIを検討

### 4.3 運用制約
- **C-009**: 初期段階ではローカル環境またはシングルサーバーでの運用
- **C-010**: GPUリソースの制限により同時処理数に上限あり

---

## 5. インターフェース要件

### 5.1 ユーザーインターフェース
- **UI-001**: シンプルで直感的なWebインターフェース
- **UI-002**: ドラッグ&ドロップでの画像アップロード
- **UI-003**: 処理中の進捗表示（プログレスバー）
- **UI-004**: 結果のサイドバイサイド表示
- **UI-005**: レスポンシブデザイン

### 5.2 APIインターフェース（将来的な拡張）
- **API-001**: RESTful API設計
- **API-002**: 画像アップロードエンドポイント
- **API-003**: 処理ステータス確認エンドポイント
- **API-004**: 結果取得エンドポイント

---

## 6. データ要件

### 6.1 入力データ
- **D-001**: 画像形式：JPEG、PNG
- **D-002**: カラースペース：RGB
- **D-003**: 解像度：最小512x512、最大4096x4096ピクセル

### 6.2 出力データ
- **D-004**: 生成画像：PNG形式（可逆圧縮）
- **D-005**: メタデータ：JSON形式
  - 変更箇所の座標
  - 変更タイプ
  - 難易度情報
  - 処理時間

### 6.3 データ保存
- **D-006**: アップロード画像は処理後24時間で削除
- **D-007**: 生成結果は一時的にサーバーに保存（セッション管理）
- **D-008**: 将来的にはユーザーアカウントに紐づけて永続化

---

## 7. 品質要件

### 7.1 精度要件
- **Q-001**: 物体検出の精度：IoU 0.7以上
- **Q-002**: 画像補完の品質：SSIM 0.9以上（変更箇所以外）
- **Q-003**: 顕著性マップの妥当性：視覚的に違和感のない間違い配置

### 7.2 ユーザビリティ
- **Q-004**: UIの操作学習時間：初回利用者が5分以内に使用可能
- **Q-005**: エラーメッセージの明確性：問題と解決策を記載

### 7.3 信頼性
- **Q-006**: AIモデルのエラー発生率：5%以下
- **Q-007**: システムクラッシュゼロ（エラーハンドリングの徹底）

---

## 8. テスト要件

### 8.1 単体テスト
- **T-001**: 各AIモジュールの単体テスト
- **T-002**: 画像処理関数のテスト
- **T-003**: APIエンドポイントのテスト

### 8.2 統合テスト
- **T-004**: エンドツーエンドの処理フローテスト
- **T-005**: 様々な画像タイプでのテスト

### 8.3 性能テスト
- **T-006**: 処理時間の計測
- **T-007**: GPUメモリ使用量の監視
- **T-008**: 同時接続時の負荷テスト

### 8.4 ユーザビリティテスト
- **T-009**: 実際のユーザーによる操作テスト
- **T-010**: UIの使いやすさ評価

---

## 9. 前提条件と依存関係

### 9.1 前提条件
- **P-001**: CUDA対応GPUを搭載したサーバーまたはローカル環境
- **P-002**: Python開発環境の構築済み
- **P-003**: UV（Pythonパッケージマネージャー）の使用

### 9.2 外部依存
- **P-004**: インターネット接続（AIモデルのダウンロード）
- **P-005**: 各種Pythonライブラリのインストール可能
- **P-006**: Flaskフレームワークの利用

---

## 10. リスクと対応策

### 10.1 技術的リスク

| リスク | 影響度 | 対応策 |
|--------|--------|---------|
| GPU環境の構築困難 | 高 | クラウドGPUサービス（AWS、GCP）の利用検討 |
| AIモデルの処理時間超過 | 中 | 軽量モデル（SAM 2 Tiny）の採用、バッチ処理の導入 |
| 画像補完の品質不足 | 中 | リファインメント機能の活用、複数モデルの比較検討 |
| DeepGazeのライセンス問題 | 中 | OpenCV Saliency APIへの代替実装 |
| メモリ不足エラー | 中 | 画像のダウンサイジング、段階的処理 |

### 10.2 運用リスク

| リスク | 影響度 | 対応策 |
|--------|--------|---------|
| 同時アクセス集中 | 中 | キューイングシステムの導入、処理待機メッセージ表示 |
| 不適切な画像のアップロード | 低 | 利用規約の明示、コンテンツフィルタリング |
| ストレージ容量不足 | 低 | 定期的な一時ファイル削除、ストレージ監視 |

---

## 11. 成功基準

### 11.1 MVP段階
- **S-001**: 1枚の画像から間違い探しを自動生成できる
- **S-002**: 生成した画像が視覚的に自然である
- **S-003**: 処理時間が許容範囲内（2分以内）
- **S-004**: 3つの難易度レベルが機能する

### 11.2 初期リリース
- **S-005**: 10名のテストユーザーが問題なく利用できる
- **S-006**: UIが直感的で使いやすいと評価される
- **S-007**: 生成された間違い探しが実際にプレイ可能

---

## 12. 用語集

| 用語 | 定義 |
|------|------|
| セグメンテーション | 画像内の物体を検出し、ピクセル単位で領域を分離する処理 |
| 顕著性マップ | 人間が画像を見たときに注目しやすい領域を可視化したマップ |
| Inpainting | 画像の一部を削除し、周囲のピクセル情報から自然に補完する技術 |
| IoU | Intersection over Union：セグメンテーション精度の評価指標 |
| SSIM | Structural Similarity Index：画像の構造的類似性を測る指標 |
| MVP | Minimum Viable Product：最小限の機能を持つ製品 |

---

## 13. 参考文献
- SAM 2公式リポジトリ: https://github.com/facebookresearch/segment-anything-2
- LaMa公式リポジトリ: https://github.com/advimman/lama
- DeepGaze公式リポジトリ: https://github.com/matthias-k/DeepGaze
- SAGUS論文: https://ipsj.ixsq.nii.ac.jp/records/210249

---

**文書バージョン**: 1.0
**最終更新日**: 2026-02-08
**作成者**: Claude Code
