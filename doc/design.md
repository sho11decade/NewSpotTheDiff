# 次世代型間違い探し自動生成システム - 設計概要

## 1. プロジェクト概要

本システムは、画像から自動的に間違い探し問題を生成することを目的としたWebアプリケーションです。最新のAI技術を活用することで、ユーザーが提供した任意の画像に対して、複数の間違いを自然に挿入し、オリジナルの間違い探しコンテンツを自動生成します。

### 主な特徴
- **最新AI技術の活用**: SAM 2、LaMa、顕著性解析を統合
- **簡単な操作**: 画像をアップロードするだけで自動生成
- **難易度調整**: 簡単・普通・難しいの3段階から選択可能
- **高品質な出力**: 自然で違和感のない間違い探し画像
- **Webベース**: ブラウザから誰でも利用可能

---

## 2. 先行事例

### SAGUS: 顕著性マップを用いた間違い探し自動生成
- **論文URL**: https://ipsj.ixsq.nii.ac.jp/records/210249
- **アプローチ**: 顕著性マップを活用した物体選択と変更
- **変更タイプ**: 削除、追加、色変化の3種類
- **難易度**: 3段階の調整機能

**本システムとの違い**:
- より高精度なAIモデル（SAM 2、LaMa）を採用
- Webインターフェースによる簡単な利用
- 顕著性解析の改良（OpenCV Saliency API）

---

## 3. システム構成

### 3.1 技術スタック（2パターン）

#### パターンA: 軽量版（推奨 - ノートPC対応）

| カテゴリ | 技術 | バージョン | 目的 |
|---------|------|-----------|------|
| **バックエンド** | Python | 3.10+ | 主要開発言語 |
| | Flask | 3.x | Webフレームワーク |
| | UV | 最新 | パッケージ管理 |
| **AI/ML** | Ultralytics | 最新 | FastSAM実行環境 |
| | FastSAM | x | 物体セグメンテーション |
| **画像処理** | OpenCV | 4.8+ | 顕著性解析、画像補完 |
| | Pillow | 10+ | 画像I/O |
| **データ管理** | SQLite | 3 | メタデータ保存 |
| **フロントエンド** | HTML5/CSS3/JS | - | ユーザーインターフェース |
| **計算環境** | CPU | - | GPU不要 |

**性能**: 15-40秒、メモリ2-3GB、初期投資0円

#### パターンB: GPU版（高品質）

| カテゴリ | 技術 | バージョン | 目的 |
|---------|------|-----------|------|
| **バックエンド** | Python | 3.10+ | 主要開発言語 |
| | Flask | 3.x | Webフレームワーク |
| | UV | 最新 | パッケージ管理 |
| **AI/ML** | PyTorch | 2.5+ | ディープラーニングフレームワーク |
| | SAM 2 | Tiny | 物体セグメンテーション |
| | LaMa | big-lama | 画像補完 |
| **画像処理** | OpenCV | 4.8+ | 顕著性解析、画像処理 |
| | Pillow | 10+ | 画像I/O |
| **データ管理** | SQLite | 3 | メタデータ保存 |
| **フロントエンド** | HTML5/CSS3/JS | - | ユーザーインターフェース |
| **計算環境** | CUDA | 12.1+ | GPU処理 |

**性能**: 40-60秒、メモリ4-6GB、初期投資20-50万円

### 3.2 推奨構成の選択

```
[ノートPC環境]
   ├─ 予算制限あり → 軽量版（FastSAM + OpenCV）
   ├─ 処理枚数 <100/日 → 軽量版
   └─ 迅速な開発 → 軽量版

[GPUサーバー環境]
   ├─ 最高品質必須 → GPU版（SAM 2 + LaMa）
   ├─ 処理枚数 >1000/日 → GPU版
   └─ 予算潤沢 → GPU版

[推奨]: まず軽量版で開始 → 必要に応じてGPU版追加
```

### 3.3 AIモジュール詳細

#### パターンA: 軽量版のモジュール

##### FastSAM (Fast Segment Anything Model)
- **開発元**: Ultralytics
- **ライセンス**: AGPL-3.0（商用利用はライセンス購入推奨）
- **目的**: 画像内の物体検出とセグメンテーション
- **選択モデル**: FastSAM-x（68M パラメータ）
- **処理時間**: 8-12秒/画像（CPU: Core i7）
- **メモリ**: 800MB-1.2GB
- **精度**: IoU 0.837（SAM 2の95%）
- **特徴**: 高速、CPU実行可能、実装簡単

##### OpenCV Inpainting
- **ライセンス**: Apache 2.0
- **目的**: 物体削除と画像補完
- **選択アルゴリズム**: Navier-Stokes法
- **処理時間**: 2-4秒/物体
- **メモリ**: 50-250MB
- **品質**: SSIM 0.82（LaMaの87%）
- **特徴**: 超高速、CPU実行、小〜中サイズ物体に最適

##### OpenCV Saliency API
- **ライセンス**: Apache 2.0
- **目的**: 人間の注目度解析
- **選択アルゴリズム**: Spectral Residual
- **処理時間**: 0.1-0.2秒/画像
- **特徴**: 高速、実用的な精度（GPU版と同じ）

**軽量版の総処理時間**: 15-40秒（難易度により変動）
**必要メモリ**: 2-3GB
**必要環境**: ノートPC（Core i5、8GB RAM）

---

#### パターンB: GPU版のモジュール

##### SAM 2 (Segment Anything Model 2)
- **開発元**: Meta AI Research
- **ライセンス**: Apache 2.0
- **目的**: 画像内の物体検出とセグメンテーション
- **選択モデル**: Tiny（38.9M パラメータ）
- **処理時間**: 20-30秒/画像（GPU: RTX 3090）
- **メモリ**: 1.5-2.0GB VRAM
- **精度**: IoU 0.884（100%基準）
- **特徴**: 最高精度、GPU必須

##### LaMa (Large Mask Inpainting)
- **開発元**: Samsung AI Center
- **ライセンス**: Apache 2.0
- **目的**: 物体削除と画像補完
- **選択モデル**: big-lama
- **処理時間**: 5-15秒/物体（GPU: RTX 3090）
- **メモリ**: 2.0-3.0GB VRAM
- **品質**: SSIM 0.942（100%基準）
- **特徴**: 最高品質、周期パターンに強い

##### OpenCV Saliency API
- **ライセンス**: Apache 2.0
- **目的**: 人間の注目度解析
- **選択アルゴリズム**: Spectral Residual
- **処理時間**: 0.1-0.2秒/画像
- **特徴**: 高速、実用的な精度

**GPU版の総処理時間**: 40-60秒（難易度により変動）
**必要メモリ**: 4-6GB（うちVRAM 3.5-5.0GB）
**必要環境**: CUDA対応GPU（8GB VRAM以上）

---

## 4. システムフロー

### 4.1 メイン処理フロー

```
┌─────────────────────────────────────┐
│  1. ユーザーが画像をアップロード          │
│     - 形式: JPEG, PNG                  │
│     - サイズ: 最大10MB                 │
│     - 解像度: 512x512 ~ 4096x4096    │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  2. 画像バリデーションと前処理          │
│     - ファイル形式チェック              │
│     - サイズチェック                   │
│     - 色空間変換（RGB）                │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  3. SAM 2による物体セグメンテーション    │
│     - 自動マスク生成                   │
│     - バウンディングボックス抽出        │
│     - 小物体のフィルタリング            │
│     ⏱ 処理時間: 20-30秒              │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  4. OpenCVによる顕著性解析            │
│     - 顕著性マップ生成                 │
│     - 各セグメントのスコア計算          │
│     - 顕著性によるランク付け            │
│     ⏱ 処理時間: 0.1-0.2秒            │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  5. 難易度に基づく物体選択             │
│     - 簡単: 高顕著性、3-4個変更       │
│     - 普通: 中顕著性、5-6個変更       │
│     - 難しい: 低顕著性、7-10個変更     │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  6. 変更タイプの決定と適用             │
│     ├─ 削除: LaMaで補完              │
│     ├─ 色変更: HSV色空間で変換        │
│     └─ 追加: セグメントの複製と配置    │
│     ⏱ 処理時間: 15-80秒              │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  7. 結果画像とメタデータの生成          │
│     - 変更箇所の座標情報              │
│     - 変更タイプ                      │
│     - 処理時間                        │
│     - JSON形式で保存                  │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  8. ユーザーへの結果表示               │
│     - オリジナルと変更後を並べて表示    │
│     - 画像のダウンロード               │
│     - メタデータのダウンロード          │
└─────────────────────────────────────┘

⏱ 総処理時間: 40-120秒（難易度により変動）
```

### 4.2 難易度別の処理詳細

| 難易度 | 変更数 | 顕著性範囲 | 処理時間 | プレイ難易度 |
|-------|-------|-----------|---------|------------|
| 簡単 | 3-4個 | 0.6-1.0（高） | 40-60秒 | すぐ見つかる |
| 普通 | 5-6個 | 0.3-0.7（中） | 60-90秒 | 探す必要あり |
| 難しい | 7-10個 | 0.0-0.4（低） | 90-120秒 | かなり難しい |

---

## 5. アーキテクチャ図

```
┌────────────────────────────────────────────────────┐
│                    Client Layer                     │
│              (Web Browser - HTML/CSS/JS)            │
└──────────────────────┬─────────────────────────────┘
                       │ HTTPS
                       ↓
┌────────────────────────────────────────────────────┐
│               Presentation Layer                    │
│                  (Flask Routes)                     │
│  ┌──────────┬──────────┬──────────┬──────────┐    │
│  │  Main    │  Upload  │ Generate │  Result  │    │
│  │  Page    │  Image   │  Process │  Display │    │
│  └──────────┴──────────┴──────────┴──────────┘    │
└──────────────────────┬─────────────────────────────┘
                       ↓
┌────────────────────────────────────────────────────┐
│              Business Logic Layer                   │
│           (Difference Generator Service)            │
└──────────────────────┬─────────────────────────────┘
                       ↓
┌────────────────────────────────────────────────────┐
│                AI Processing Layer                  │
│  ┌──────────────┬───────────────┬──────────────┐  │
│  │ SAM 2        │ OpenCV        │ LaMa         │  │
│  │ Segmentation │ Saliency      │ Inpainting   │  │
│  │ Service      │ Service       │ Service      │  │
│  └──────────────┴───────────────┴──────────────┘  │
└──────────────────────┬─────────────────────────────┘
                       ↓
┌────────────────────────────────────────────────────┐
│                 Data Layer                          │
│  ┌────────────────┬─────────────────────────┐     │
│  │ File System    │ SQLite Database         │     │
│  │ (Images)       │ (Metadata/History)      │     │
│  └────────────────┴─────────────────────────┘     │
└────────────────────────────────────────────────────┘
```

---

## 6. 変更タイプの実装詳細

### 6.1 物体の削除（Deletion）
```
[元画像] → [マスク生成] → [LaMa補完] → [削除完了]
```
- LaMaを使用して高品質な補完
- 周囲のテクスチャを自然に延長
- 処理時間: 5-15秒/物体

### 6.2 色の変更（Color Change）
```
[元画像] → [HSV変換] → [色相シフト] → [RGB変換] → [色変更完了]
```
- HSV色空間での色相シフト（30-150度）
- セグメント領域のみ変更
- 処理時間: ~1秒/物体

### 6.3 物体の追加（Addition）
```
[元画像] → [セグメント抽出] → [配置位置決定] → [ブレンディング] → [追加完了]
```
- 既存セグメントの複製
- 空きスペースの自動検出
- マスク領域のみコピー
- 処理時間: ~2秒/物体

---

## 7. データモデル

### 7.1 GenerationHistory（SQLite）
```sql
CREATE TABLE generation_history (
    id INTEGER PRIMARY KEY,
    session_id TEXT NOT NULL,
    original_filename TEXT,
    output_path TEXT,
    difficulty TEXT,
    num_differences INTEGER,
    processing_time REAL,
    metadata TEXT,  -- JSON
    created_at TIMESTAMP,
    expires_at TIMESTAMP
);
```

### 7.2 メタデータJSON
```json
{
  "differences": [
    {
      "id": 1,
      "type": "deletion",
      "bbox": [100, 150, 250, 300],
      "polygon": [[120, 160], ...],
      "saliency_score": 0.35
    }
  ],
  "difficulty": "medium",
  "total_differences": 5,
  "processing_steps": {
    "segmentation_time": 28.5,
    "saliency_time": 0.15,
    "inpainting_time": 45.7,
    "total_time": 87.2
  }
}
```

---

## 8. システム要件

### 8.1 ハードウェア要件（パターンA: 軽量版）

**最小構成**（動作可能）:
- CPU: Intel Core i5 第8世代以上 / AMD Ryzen 5 3000シリーズ以上
- RAM: 8GB
- ストレージ: 5GB（モデル含む）
- GPU: **不要**

**推奨構成**（快適動作）:
- CPU: Intel Core i7 第10世代以上 / AMD Ryzen 7 4000シリーズ以上
- RAM: 16GB
- ストレージ: 10GB（SSD推奨）
- GPU: **不要**

**処理性能**:
- 処理時間: 15-40秒/画像
- 同時処理: 2-3ジョブ
- メモリ使用量: 2-3GB

---

### 8.2 ハードウェア要件（パターンB: GPU版）

**最小構成**:
- CPU: Intel Core i5以上
- RAM: 16GB
- GPU: NVIDIA GTX 1060（6GB VRAM）
- ストレージ: 50GB以上

**推奨構成**:
- CPU: Intel Core i7以上
- RAM: 32GB
- GPU: NVIDIA RTX 3070以上（8GB VRAM）
- ストレージ: 100GB以上（SSD）

**処理性能**:
- 処理時間: 40-60秒/画像
- 同時処理: 3-5ジョブ
- メモリ使用量: 4-6GB（うちVRAM 3.5-5.0GB）

---

### 8.3 ソフトウェア要件

#### 共通要件
- Python: 3.10以上
- OS: Windows 10以上 / Ubuntu 20.04以上 / macOS 12以上

#### 軽量版追加要件
- Ultralytics: 最新版
- OpenCV: 4.8以上
- NumPy: 1.24以上

#### GPU版追加要件
- CUDA: 12.1以上
- NVIDIA Driver: 最新版
- PyTorch: 2.5以上（CUDA対応）
- CUDAツールキット

---

## 9. セキュリティ対策

| 脅威 | 対策 |
|------|------|
| 悪意のあるファイル | ファイル形式検証、サイズ制限、マジックバイトチェック |
| パストラバーサル | UUIDベースのファイル名、パスサニタイズ |
| XSS | 入力エスケープ、Content-Security-Policy |
| CSRF | CSRFトークン（Flask-WTF） |
| DoS | レート制限、タイムアウト設定 |

---

## 10. 性能目標

| 指標 | 目標値 |
|------|--------|
| 画像アップロード時間 | < 5秒 |
| 物体セグメンテーション | < 30秒 |
| 顕著性解析 | < 1秒 |
| 画像補完（1物体） | < 15秒 |
| 総処理時間 | < 120秒 |
| 同時処理数 | 3ジョブ |

---

## 11. 関連ドキュメント

本プロジェクトには以下の詳細ドキュメントが用意されています:

### 必須ドキュメント（実装前に必読）

1. **[軽量版設計書](lightweight_design.md)** - ノートPC対応の軽量版技術スタック
   - FastSAM + OpenCV Inpaintingの詳細
   - 完全なPythonコード例（200行）
   - 処理時間15-40秒、メモリ2-3GB

2. **[比較ガイド](comparison_guide.md)** - GPU版 vs 軽量版の詳細比較
   - 性能・コスト・品質の詳細比較表
   - 使用シーン別の推奨
   - 選択フローチャート
   - FAQ

### 詳細仕様書

3. **[要件定義書](requirements.md)** - 機能要件・非機能要件の詳細
4. **[システム設計書](system_architecture.md)** - アーキテクチャ・API設計の詳細
5. **[実装計画](implementation_plan.md)** - フェーズ別の実装手順とコード例
6. **[技術リサーチ](technical_research.md)** - GPU版AI技術の詳細調査結果

### 推奨読書順序

**ノートPC環境の場合**:
1. [比較ガイド](comparison_guide.md) - 軽量版が適しているか確認
2. [軽量版設計書](lightweight_design.md) - 実装方法を学習
3. [要件定義書](requirements.md) - 機能要件を確認
4. [実装計画](implementation_plan.md) - 実装を開始

**GPUサーバー環境の場合**:
1. [比較ガイド](comparison_guide.md) - GPU版が適しているか確認
2. [技術リサーチ](technical_research.md) - GPU版技術を学習
3. [システム設計書](system_architecture.md) - 詳細設計を確認
4. [実装計画](implementation_plan.md) - 実装を開始

---

## 12. ライセンス

### パターンA: 軽量版
- **FastSAM**: AGPL-3.0
  - オープンソース利用: 無料
  - 商用利用: ソースコード公開が必要、またはUltralyticsライセンス購入（$999〜）
  - **代替**: Mobile SAM（Apache 2.0、完全無料）
- **OpenCV**: Apache 2.0（商用利用可能）
- **Ultralytics**: AGPL-3.0（同上）

**注意**: FastSAMの商用利用にはライセンス購入が必要です。完全無料で商用利用したい場合はMobile SAMへの変更を推奨します。

### パターンB: GPU版
- **SAM 2**: Apache 2.0（商用利用可能）
- **LaMa**: Apache 2.0（商用利用可能）
- **OpenCV**: Apache 2.0（商用利用可能）

**GPU版は全て商用利用可能です。**

### 推奨ライセンス戦略

**個人・学習目的**: 軽量版（FastSAM使用、AGPL-3.0）
**商用（予算なし）**: 軽量版（Mobile SAM使用、Apache 2.0）
**商用（予算あり）**: 軽量版（Ultralyticsライセンス購入）またはGPU版

---

**文書バージョン**: 3.0（軽量版対応）
**最終更新日**: 2026-02-08
**作成者**: Claude Code
